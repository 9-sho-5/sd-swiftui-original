//
//  PromptBuilder.swift
//  sd-swiftui-original
//
//  Created by ã»ã—ã‚‡ on 2025/06/26.
//

import Foundation

struct PromptBuilder {
    static func buildConversionPrompt(input: String, for platform: PlatformType) -> String {
        let platformGuidance = platformGuidanceText(for: platform)

        return """
        ã‚ãªãŸã¯ã‚¢ãƒ—ãƒªé–“ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´å½¢ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
        ä»¥ä¸‹ã®æ¡ä»¶ã‚’å®ˆã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’\(platform.displayName)å‘ã‘ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚

        â–  å…¨ä½“ãƒ«ãƒ¼ãƒ«
        - ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚„çµµæ–‡å­—ã€ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãªã©ã€ã™ã¹ã¦ã®ç‰¹æ®Šæ§‹æ–‡ã¯ãã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å…¬å¼ä»•æ§˜ã«åŽ³å¯†ã«æº–æ‹ ã—ã¦ãã ã•ã„ã€‚
        - æ”¹è¡Œã‚„æ®µè½æ§‹é€ ã¯ä¿æŒã—ã€å…ƒã®æ–‡æ„ã‚’æãªã‚ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
        - Macã‚„Windowsã§ä½¿ãˆã‚‹æ¨™æº–çµµæ–‡å­—ã¯ãã®ã¾ã¾æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚
        - å¤‰æ›å…ˆã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ä½¿ç”¨ã§ããªã„çµµæ–‡å­—ã¯ã€å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

        â–  \(platform.displayName)ã®è©³ç´°ä»•æ§˜
        \(platformGuidance)

        â–  å¤‰æ›å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ
        \"\"\"
        \(input)
        \"\"\"
        """
    }

    private static func platformGuidanceText(for platform: PlatformType) -> String {
        switch platform {
        case .slack:
            return """
            - ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼š
              ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š `@ãƒ¦ãƒ¼ã‚¶ãƒ¼å` ã®å½¢å¼ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã¾ã™ï¼ˆä¾‹ï¼š`@yamada`ï¼‰  
              ãƒãƒ£ãƒ³ãƒãƒ«ï¼š `#ãƒãƒ£ãƒ³ãƒãƒ«å` ã®å½¢å¼ã§ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å‚ç…§ã§ãã¾ã™ï¼ˆä¾‹ï¼š`#general`ï¼‰  
              å…¨ä½“å®›ã¦ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼š
                - `@here`ï¼šç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸­ã®ãƒ¡ãƒ³ãƒãƒ¼ã«é€šçŸ¥
                - `@channel`ï¼šãƒãƒ£ãƒ³ãƒãƒ«å†…ã®å…¨å“¡ã«é€šçŸ¥
                - `@everyone`ï¼šå…¨ãƒ¡ãƒ³ãƒãƒ¼ã«é€šçŸ¥ï¼ˆ#generalãªã©ä¸€éƒ¨ã®ãƒãƒ£ãƒ³ãƒãƒ«ã§ã®ã¿ä½¿ç”¨å¯èƒ½ï¼‰

            - çµµæ–‡å­—ï¼š
              Slackã§ã¯ `:emoji_name:` å½¢å¼ã§çµµæ–‡å­—ã‚’æŒ¿å…¥ã§ãã¾ã™ã€‚æ¨™æº–çµµæ–‡å­—ï¼ˆä¾‹ï¼š`:smile:`ï¼‰ã«åŠ ãˆã€
              ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸ**ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—**ã‚‚ä½¿ç”¨å¯èƒ½ã§ã™ã€‚  
              ãŸã ã—ã€Slackå¤–ã§ã¯è¡¨ç¤ºã§ããªã„ãŸã‚ã€ä»–ã‚¢ãƒ—ãƒªå‘ã‘ã«å¤‰æ›ã™ã‚‹éš›ã¯å‰Šé™¤ã¾ãŸã¯æ¨™æº–çµµæ–‡å­—ã«ç½®æ›ã—ã¦ãã ã•ã„ã€‚

            - ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ï¼ˆæ›¸å¼ï¼‰å¯¾å¿œï¼š
              - **å¤ªå­—**ï¼š `*ãƒ†ã‚­ã‚¹ãƒˆ*` ã¾ãŸã¯ `Ctrl/Cmd + B`
              - *æ–œä½“*ï¼š `_ãƒ†ã‚­ã‚¹ãƒˆ_` ã¾ãŸã¯ `Ctrl/Cmd + I`
              - ~æ‰“ã¡æ¶ˆã—ç·š~ï¼š `~ãƒ†ã‚­ã‚¹ãƒˆ~`
              - `ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰`ï¼š `` `ã‚³ãƒ¼ãƒ‰` ``ï¼ˆãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆ1ã¤ï¼‰
              - ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼š ``` ```è¤‡æ•°è¡Œã‚³ãƒ¼ãƒ‰``` ```ï¼ˆãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆ3ã¤ï¼‰
              - å¼•ç”¨ï¼š `> å¼•ç”¨æ–‡`

            - ãã®ä»–ï¼š
              Slackã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œã§ã™ãŒã€ä¸€éƒ¨æ©Ÿèƒ½ï¼ˆè¦‹å‡ºã—ã€ãƒªã‚¹ãƒˆãªã©ï¼‰ã¯Markdownã§ã¯ãªã
              ã‚¨ãƒ‡ã‚£ã‚¿UIã‹ã‚‰ç›´æŽ¥å…¥åŠ›ã•ã‚Œã‚‹å½¢å¼ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚è‡ªå‹•å¤‰æ›æ™‚ã¯æ›¸å¼ã®äº’æ›æ€§ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
            """


        case .discord:
            return """
            - ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼š
              ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ `@ãƒ¦ãƒ¼ã‚¶ãƒ¼å`ã€ãƒ­ãƒ¼ãƒ«ã¯ `@ãƒ­ãƒ¼ãƒ«å`ã€ãƒãƒ£ãƒ³ãƒãƒ«ã¯ `#ãƒãƒ£ãƒ³ãƒãƒ«å` ã§è¡¨ç¾ã•ã‚Œã¾ã™ã€‚
              å…¨ä½“å®›ã¦ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¯ `@here`ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸­ã®å…¨å“¡ï¼‰ã¾ãŸã¯ `@everyone`ï¼ˆå…¨å“¡ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
              Slackã® `@channel` ã«ç›¸å½“ã™ã‚‹æ©Ÿèƒ½ã¯ `@everyone` ã§ã™ã€‚

            - çµµæ–‡å­—ï¼š
              ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã¯ `:emoji_name:` ã®å½¢å¼ã§ä½¿ç”¨ã§ãã¾ã™ï¼ˆä¾‹ï¼š`:partyparrot:`ï¼‰ã€‚
              Unicodeçµµæ–‡å­—ï¼ˆä¾‹ï¼šðŸ™‚ï¼‰ã‚‚ä½¿ç”¨å¯èƒ½ã§ã™ã€‚
              ä»–ã®ã‚¢ãƒ—ãƒªã§è¡¨ç¤ºã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦å‰Šé™¤ã¾ãŸã¯ç½®æ›ã—ã¦ãã ã•ã„ã€‚

            - ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¯¾å¿œï¼š
              **å¤ªå­—** â†’ `**ãƒ†ã‚­ã‚¹ãƒˆ**` ã¾ãŸã¯ `__ãƒ†ã‚­ã‚¹ãƒˆ__`  
              *æ–œä½“* â†’ `*ãƒ†ã‚­ã‚¹ãƒˆ*` ã¾ãŸã¯ `_ãƒ†ã‚­ã‚¹ãƒˆ_`  
              __ä¸‹ç·š__ â†’ `__ãƒ†ã‚­ã‚¹ãƒˆ__`  
              ~~å–ã‚Šæ¶ˆã—ç·š~~ â†’ `~~ãƒ†ã‚­ã‚¹ãƒˆ~~`  
              `ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰` â†’ `` `ã‚³ãƒ¼ãƒ‰` ``  
              è¤‡æ•°è¡Œã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ â†’ ``` ```è¨€èªžåï¼ˆä»»æ„ï¼‰\nã‚³ãƒ¼ãƒ‰\n``` ```
              > å¼•ç”¨ â†’ `> å¼•ç”¨æ–‡`ï¼ˆè¤‡æ•°è¡Œã‚‚å¯ï¼‰  
              ç®‡æ¡æ›¸ã â†’ `-` ã¾ãŸã¯ `*` ã‚’è¡Œé ­ã«  
              ç•ªå·ä»˜ããƒªã‚¹ãƒˆ â†’ `1.`, `2.` ã®ã‚ˆã†ã«è¨˜è¿°

            - æ³¨æ„ç‚¹ï¼š
              Discord ã§ã¯è¤‡æ•°ã®ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼ˆä¾‹ï¼š**_å¤ªå­—ï¼‹æ–œä½“_**ï¼‰ã€‚
              ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§ä½¿ç”¨ã™ã‚‹è¨€èªžåã¯çœç•¥å¯èƒ½ã§ã™ãŒã€ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«æŒ‡å®šã‚’æŽ¨å¥¨ã—ã¾ã™ã€‚
            """

        case .notion:
            return """
            - ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼š
              ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ãƒšãƒ¼ã‚¸ã«ã¯ `@è¡¨ç¤ºå` ã®å½¢å¼ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚
              Slackã‚„Discordã®ã‚ˆã†ãªã€Œå…¨ä½“å®›ã¦ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼ˆ@channel / @everyoneï¼‰ã€ã®æ¦‚å¿µã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚

            - çµµæ–‡å­—ï¼š
              åŸºæœ¬çš„ãªUnicodeçµµæ–‡å­—ï¼ˆðŸ™‚ãªã©ï¼‰ã¯ä½¿ç”¨å¯èƒ½ã§ã™ã€‚
              Notionã§ã¯ç‹¬è‡ªã®ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ã‚„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµµæ–‡å­—ã®ç™»éŒ²ãƒ»ä½¿ç”¨ã¯ã§ããªã„ãŸã‚ã€
              Slackã‚„Discordç”±æ¥ã®ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ï¼ˆ`:emoji_name:` å½¢å¼ãªã©ï¼‰ã¯å‰Šé™¤ã¾ãŸã¯æ¨™æº–çµµæ–‡å­—ã¸ç½®æ›ã—ã¦ãã ã•ã„ã€‚

            - ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¯¾å¿œï¼š
              **å¤ªå­—** â†’ `**ãƒ†ã‚­ã‚¹ãƒˆ**` ã¾ãŸã¯ `Ctrl/Cmd + B`  
              *æ–œä½“* â†’ `_ãƒ†ã‚­ã‚¹ãƒˆ_` ã¾ãŸã¯ `Ctrl/Cmd + I`  
              ~~å–ã‚Šæ¶ˆã—ç·š~~ â†’ `~ãƒ†ã‚­ã‚¹ãƒˆ~`ï¼ˆå¤‰æ›ã«ã¯å¯¾å¿œã—ã¾ã™ãŒNotionå´ã§æ˜Žç¤ºçš„ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãªã—ï¼‰  
              `ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰` â†’ `` `ã‚³ãƒ¼ãƒ‰` `` ã¾ãŸã¯ `Ctrl/Cmd + E`  

            - ãã®ä»–ã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆï¼ˆå¤‰æ›å¯¾è±¡å¤–ï¼‰ï¼š
              è¦‹å‡ºã—ï¼ˆä¾‹ï¼š`# ã‚¿ã‚¤ãƒˆãƒ«`ï¼‰ã‚„ç®‡æ¡æ›¸ãï¼ˆä¾‹ï¼š`- é …ç›®`ï¼‰ãªã©ã¯ Notion ç‹¬è‡ªã®ã‚¹ã‚¿ã‚¤ãƒ«ã§ç®¡ç†ã•ã‚Œã¦ãŠã‚Šã€
              Markdownã‹ã‚‰ã®å®Œå…¨ãªè‡ªå‹•å¤‰æ›ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§æ•´å½¢ã—ã¦ãã ã•ã„ã€‚
            """
        }
    }
}

// MARK: - ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ãƒã‚§ãƒƒã‚¯ï¼†é™¤åŽ»
extension PromptBuilder {
    static func needsEmojiSanitization(input: String) -> Bool {
        return extractCustomEmojis(from: input).isEmpty == false
    }

    static func extractCustomEmojis(from input: String) -> [String] {
        let regex = try! NSRegularExpression(pattern: ":[a-zA-Z0-9_]+:")
        let nsrange = NSRange(input.startIndex..., in: input)
        return regex.matches(in: input, range: nsrange).map {
            String(input[Range($0.range, in: input)!])
        }
    }

    static func sanitizedInput(from input: String) -> String {
        let regex = try! NSRegularExpression(pattern: ":[a-zA-Z0-9_]+:")
        let nsrange = NSRange(input.startIndex..., in: input)
        return regex.stringByReplacingMatches(in: input, options: [], range: nsrange, withTemplate: "")
    }
}
